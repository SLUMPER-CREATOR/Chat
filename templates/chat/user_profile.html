{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <!-- Header –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-6">
                {% if profile.avatar %}
                    <img src="{{ profile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-24 h-24 rounded-full object-cover mx-auto sm:mx-0 flex-shrink-0">
                {% else %}
                    <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center text-white text-3xl font-bold mx-auto sm:mx-0 flex-shrink-0">
                        {{ target_user.username|first|upper }}
                    </div>
                {% endif %}
                
                <div class="text-center sm:text-left">
                    <h1 class="text-3xl font-bold text-gray-800">{{ target_user.username }}</h1>
                    <p class="text-gray-600 mt-1">–£—á–∞—Å—Ç–Ω–∏–∫ —Å {{ join_date|date:"d.m.Y" }}</p>
                    {% if profile.bio %}
                        <p class="text-gray-700 mt-2 max-w-md">{{ profile.bio }}</p>
                    {% endif %}
                    
                    <!-- –õ–∞–π–∫–∏ -->
                    <div class="flex items-center justify-center sm:justify-start space-x-2 mt-3">
                        <span class="text-red-500">‚ù§Ô∏è</span>
                        <span id="likes-count" class="font-semibold">{{ likes_count }}</span>
                        <span class="text-gray-600">–ª–∞–π–∫{{ likes_count|pluralize:"–æ–≤" }}</span>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col space-y-3 w-full sm:w-auto">
                <!-- –ö–Ω–æ–ø–∫–∞ –ª–∞–π–∫–∞ -->
                {% if target_user != user %}
                    <button id="like-btn" onclick="toggleLike({{ target_user.id }})" 
                            class="flex items-center justify-center space-x-2 px-4 py-2 rounded-lg transition {% if is_liked %}bg-red-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                        <span>{% if is_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
                        <span id="like-text">{% if is_liked %}–£–±—Ä–∞—Ç—å –ª–∞–π–∫{% else %}–õ–∞–π–∫{% endif %}</span>
                    </button>
                {% endif %}
                
                <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–ø–∏—Å–∞—Ç—å -->
                {% if target_user != user %}
                    <a href="{% url 'start_private_chat' target_user.id %}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-center whitespace-nowrap">
                        –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    </a>
                {% endif %}
                
                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                <div class="flex space-x-2">
                    <a href="{% url 'private_chats' %}" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 transition text-center">
                        –ù–∞–∑–∞–¥
                    </a>
                    {% if target_user == user %}
                        <a href="{% url 'profile' %}" class="flex-1 bg-gray-600 text-white px-3 py-2 rounded text-sm hover:bg-gray-700 transition text-center">
                            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-blue-600">{{ total_messages }}</div>
            <div class="text-gray-600">–°–æ–æ–±—â–µ–Ω–∏–π</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-red-600">{{ likes_count }}</div>
            <div class="text-gray-600">–õ–∞–π–∫–æ–≤</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-purple-600">{{ user_groups.count }}</div>
            <div class="text-gray-600">–ì—Ä—É–ø–ø</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
            
            {% if user_messages %}
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    {% for message in user_messages %}
                        <div class="border-l-4 border-blue-500 pl-4 py-2">
                            <p class="text-gray-800">{{ message.content }}</p>
                            <span class="text-sm text-gray-500">{{ message.timestamp|date:"d.m.Y H:i" }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-gray-500 py-8">
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                </div>
            {% endif %}
        </div>

        <!-- –ì—Ä—É–ø–ø—ã -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">–ü—É–±–ª–∏—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã</h2>
            
            {% if user_groups %}
                <div class="space-y-3">
                    {% for group in user_groups %}
                        <div class="flex items-center justify-between p-3 border rounded-lg">
                            <div class="flex items-center space-x-3">
                                {% if group.avatar %}
                                    <img src="{{ group.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã" class="w-8 h-8 rounded-full object-cover">
                                {% else %}
                                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                        {{ group.name|first|upper }}
                                    </div>
                                {% endif %}
                                <div>
                                    <span class="font-medium">{{ group.name }}</span>
                                    <p class="text-sm text-gray-500">{{ group.members.count }} —É—á–∞—Å—Ç–Ω–∏–∫{{ group.members.count|pluralize:"–æ–≤" }}</p>
                                </div>
                            </div>
                            {% if user in group.members.all %}
                                <a href="{% url 'group_room' group.id %}" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition">
                                    –û—Ç–∫—Ä—ã—Ç—å
                                </a>
                            {% else %}
                                <a href="{% url 'join_group' group.id %}" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">
                                    –í–æ–π—Ç–∏
                                </a>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-gray-500 py-8">
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –ø—É–±–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleLike(userId) {
    fetch(`/chat/like/${userId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ª–∞–π–∫–∞
        const likeBtn = document.getElementById('like-btn');
        const likeText = document.getElementById('like-text');
        const likesCount = document.getElementById('likes-count');
        
        if (data.liked) {
            likeBtn.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg transition bg-red-500 text-white';
            likeBtn.innerHTML = '<span>‚ù§Ô∏è</span><span id="like-text">–£–±—Ä–∞—Ç—å –ª–∞–π–∫</span>';
        } else {
            likeBtn.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300';
            likeBtn.innerHTML = '<span>ü§ç</span><span id="like-text">–õ–∞–π–∫</span>';
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
        likesCount.textContent = data.likes_count;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification(data.message);
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ª–∞–π–∫–∞');
    });
}

function showNotification(message) {
    // –°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // –£–±—Ä–∞—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// –î–æ–±–∞–≤–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = '{{ csrf_token }}';
        document.body.appendChild(csrfToken);
    }
});
</script>
{% endblock %}