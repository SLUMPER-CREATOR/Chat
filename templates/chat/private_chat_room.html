{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="flex flex-col h-screen max-w-4xl mx-auto bg-white shadow rounded-lg overflow-hidden">
    <!-- Header -->
    <div class="bg-green-600 text-white p-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <a href="{% url 'private_chats' %}" class="text-white hover:text-gray-200">
                ← Назад
            </a>
            {% if other_user.userprofile.avatar %}
                <img src="{{ other_user.userprofile.avatar.url }}" alt="Аватар" class="w-8 h-8 rounded-full object-cover">
            {% else %}
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                    {{ other_user.username|first|upper }}
                </div>
            {% endif %}
            <span class="font-bold">{{ other_user.username }}</span>
        </div>
        <div class="flex space-x-2">
            <a href="{% url 'room' %}" class="bg-green-500 hover:bg-green-400 px-3 py-1 rounded text-sm transition">
                Общий чат
            </a>
        </div>
    </div>

    <!-- Сообщения -->
    <div id="chat-box" class="flex-1 overflow-y-auto p-4 bg-gray-50">
        {% for msg in messages %}
            <div class="mb-4 flex {% if msg.sender == user %}justify-end{% else %}justify-start{% endif %}">
                <div class="flex items-start space-x-2 max-w-xs lg:max-w-md">
                    {% if msg.sender != user %}
                        {% if msg.sender.userprofile.avatar %}
                            <img src="{{ msg.sender.userprofile.avatar.url }}" alt="Аватар" class="w-8 h-8 rounded-full object-cover flex-shrink-0">
                        {% else %}
                            <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                                {{ msg.sender.username|first|upper }}
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    <div class="{% if msg.sender == user %}bg-blue-500 text-white{% else %}bg-white text-gray-800{% endif %} rounded-lg px-4 py-2 shadow">
                        <p>{{ msg.content }}</p>
                        <p class="text-xs {% if msg.sender == user %}text-blue-100{% else %}text-gray-500{% endif %} mt-1">
                            {{ msg.timestamp|date:"H:i" }}
                        </p>
                    </div>
                    
                    {% if msg.sender == user %}
                        {% if user.userprofile.avatar %}
                            <img src="{{ user.userprofile.avatar.url }}" alt="Аватар" class="w-8 h-8 rounded-full object-cover flex-shrink-0">
                        {% else %}
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                                {{ user.username|first|upper }}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <div class="text-center text-gray-500 py-8">
                <p>Пока нет сообщений</p>
                <p class="text-sm">Начните общение с {{ other_user.username }}!</p>
            </div>
        {% endfor %}
    </div>

    <!-- Форма отправки -->
    <div class="border-t p-4">
        <form id="chat-form" class="flex">
            <input type="text" id="chat-input" class="flex-1 border rounded-l-lg px-4 py-2 focus:outline-none" placeholder="Напишите сообщение..." autocomplete="off">
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-r-lg hover:bg-green-700">Отправить</button>
        </form>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatId = {{ chat.id }};
    const username = "{{ user.username }}";
    const otherUsername = "{{ other_user.username }}";
    
    console.log('Приватный чат между:', username, 'и', otherUsername);
    
    {% if not user.is_authenticated %}
        console.error('Пользователь не авторизован!');
        alert('Вы не авторизованы. Перенаправляем на страницу входа...');
        window.location.href = '/accounts/login/';
    {% endif %}
    
    // Прокрутка вниз
    chatBox.scrollTop = chatBox.scrollHeight;

    // WebSocket для приватного чата
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const socket = new WebSocket(
        wsProtocol + '//' + window.location.host + '/ws/private/' + chatId + '/'
    );
    console.log('Подключаемся к приватному чату:', wsProtocol + '//' + window.location.host + '/ws/private/' + chatId + '/');

    socket.onopen = function(e) {
        console.log('Приватный чат подключен');
    };

    socket.onclose = function(e) {
        console.log('Приватный чат отключен:', e.code, e.reason);
        if (e.code !== 1000) {
            // Попытка переподключения через 3 секунды
            setTimeout(() => {
                console.log('Попытка переподключения...');
                location.reload();
            }, 3000);
        }
    };

    socket.onerror = function(e) {
        console.log('Ошибка приватного чата:', e);
    };

    socket.onmessage = function(e) {
        console.log('Получено приватное сообщение:', e.data);
        const data = JSON.parse(e.data);
        if (data.type === 'private_message') {
            addMessageToChat(data.message, data.username, data.avatar_url, data.timestamp);
        }
    };

    function addMessageToChat(message, senderUsername, avatarUrl, timestamp) {
        const isCurrentUser = senderUsername === username;
        const div = document.createElement('div');
        div.className = `mb-4 flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
        
        let avatarHtml;
        if (avatarUrl) {
            avatarHtml = `<img src="${avatarUrl}" alt="Аватар" class="w-8 h-8 rounded-full object-cover flex-shrink-0">`;
        } else {
            const bgColor = isCurrentUser ? 'bg-blue-600' : 'bg-green-600';
            avatarHtml = `<div class="w-8 h-8 ${bgColor} rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                ${senderUsername.charAt(0).toUpperCase()}
            </div>`;
        }
        
        const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const messageClass = isCurrentUser ? 'bg-blue-500 text-white' : 'bg-white text-gray-800';
        const timeClass = isCurrentUser ? 'text-blue-100' : 'text-gray-500';
        
        div.innerHTML = `
            <div class="flex items-start space-x-2 max-w-xs lg:max-w-md">
                ${!isCurrentUser ? avatarHtml : ''}
                <div class="${messageClass} rounded-lg px-4 py-2 shadow">
                    <p>${message}</p>
                    <p class="text-xs ${timeClass} mt-1">${time}</p>
                </div>
                ${isCurrentUser ? avatarHtml : ''}
            </div>
        `;
        
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
        const message = chatInput.value.trim();
        if (message) {
            if (socket.readyState === WebSocket.OPEN) {
                console.log('Отправляем приватное сообщение:', message);
                socket.send(JSON.stringify({
                    'message': message,
                    'username': username,
                    'chat_id': chatId
                }));
                chatInput.value = '';
            } else {
                console.log('WebSocket не подключен. Состояние:', socket.readyState);
                alert('Соединение потеряно. Страница будет перезагружена.');
                location.reload();
            }
        }
    }

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });

    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
{% endblock %}